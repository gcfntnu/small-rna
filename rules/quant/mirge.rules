#-*- mode:snakemake -*-
import shutil
import os

include:
    'mirge.db'


rule mirge_symlink:
    input:
        get_filtered_fastq
    params:
        outdir = os.path.abspath('data/tmp/GCF-2018-547-tmp/mirge/fastq')
    output:
        os.path.join('data/tmp/GCF-2018-547-tmp/mirge/fastq', '{sample}.fastq.gz')
    run:
        import os
        src = os.path.abspath(input[0])
        dst = os.path.abspath(output[0])
        os.symlink(src, dst)
        print('symlinking: {} > {}'.format(src, dst))

rule mirge_annotate:
    input:
        fastq = expand(rules.mirge_symlink.output, sample=SAMPLES),
        db = 'data/ext/mirge/{org}/index.Libs/{org}_snorna.3.ebwt'
    params:
        bp = '/home/flatberg/miniconda3/envs/mirge/bin' ,
        lib = 'data/ext/mirge',
        args = '-di -ai -gff -spikeIn',
        out = 'data/processed/mirge/{org}/{db}'
    output:
        'data/processed/mirge/{org}/{db}/.done'
    conda:
        'envs/mirge.yaml'
    threads:
        8
    shell:
        'miRge2.0 annotate '
        '-s {input.fastq} '
        '-d {wildcards.db} '
        '-pb {params.bp} '
        '-lib {params.lib} '
        '-sp {wildcards.org} '
        '{params.args} '
        '-cpu {threads} '
        '-o {params.out} '
