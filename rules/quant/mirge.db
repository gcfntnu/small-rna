#-*- mode:snakemake -*-
"""miRge - microRNA alignment software for small RNA-seq data

https://github.com/mhalushka/miRge


This is the database download part.

For DB builds: https://github.com/mhalushka/miRge_build

"""
from os.path import join

URLS =  {'human':
         'https://jh.box.com/shared/static/rj7ufy5v15uw7ytsyyrsryw99u7ml82j.gz',
         'mouse':
         'mouse.tar.gz https://jh.box.com/shared/static/z2bcey8j9e9nxnvpmb4fm88zzq3da4m1.gz',
         'rat':
         'rat.tar.gz https://jh.box.com/shared/static/mmztv42j8h7snk0eo80o7a7t30it4q9f.gz',
         'zebrafish':
         'https://jh.box.com/shared/static/nwn7jzn5ekgm51k7jlk43a6h75aasgr1.gz',
         'nematode':
         'https://jh.box.com/shared/static/nwn7jzn5ekgm51k7jlk43a6h75aasgr1.gz',
         'fruitfly':
         'fruitfly.tar.gz https://jh.box.com/shared/static/ilrnq62cp06pviir5t0mh85aqet0fmjq.gz'
         }

MIRGE_ORG_MAP = {'homo_sapiens': 'human',
                 'human': 'human',
                 'hsa': 'human',
                 'mus_musculus': 'mouse',
                 'mouse': 'mouse',
                 'mm10': 'mouse',
                 'rattus_norvegicus': 'rat',
                 'rat': 'rat',
                 'rnor6': 'rat'}
MIRGE_ORG = MIRGE_ORG_MAP[config['organism']]

rule download_db:
    params:
        url = lambda wildcards: URLS[MIRGE_ORG],
        out = lambda wildcards: join(EXT_DIR, 'mirge', MIRGE_ORG)
    output:
        join(EXT_DIR, 'mirge', MIRGE_ORG, 'index.Libs', 'human_snorna.3.ebwt')
    shell:
        'wget -qO- {params.url} | tar xvz --strip-components 1 -C {params.out}'

rule add_trf_human:
    input:
        rules.download_db.output
    params:
        url = 'https://github.com/mhalushka/miRge/files/2428450/missingtrffiles.zip',
        outdir = join(EXT_DIR, 'mirge', MIRGE_ORG, 'annotation.Libs')
    output:
        join(EXT_DIR, 'mirge', MIRGE_ORG, 'annotation.Libs', 'human_trna.str')
    shell:
        """
        wget {params.url}
        unzip missingtrffiles.zip -d {params.outdir}
        rm missingtrffiles.zip
        """

rule mirge_db:
    input:
        expand('data/ext/mirge/{org}/index.Libs/{org}_snorna.3.ebwt', org=MIRGE_ORG)
