#-*- mode:snakemake -*-

from os.path import join, abspath

rule unitas:
    input:
        fastq = get_filtered_fastq
    params:
        org = lambda wildcards: config['samples'][wildcards.samples].get('organism', 'homo_sapiens'),
        tmpdir = join(QUANT_INTERIM, 'unitas'),
        outdir = abspath(join(QUANT_PROCESSED, 'unitas', '{sample}')),
        args = '-riborase '
    output:
        join(QUANT_PROCESSED, 'unitas', '{sample}', 'results.html')
    singularity:
        'docker://flatberg/unitas:1.6.0'
    threads:
        1
    shell:
        """
        mkdir -p {params.tmpdir}
        cd {params.tmpdir} || exit
        rm -rf *_#*
        unitas.pl -input {input.fastq} -s {params.org} -threads {threads} {params.args}
        mv UNITAS_*_{wildcards.sample}.*fastq_#1/* {params.outdir}/
        """
