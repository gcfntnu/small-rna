#-*- mode:snakemake -*-

include:
    'sortmerna.rules'

rule rrna_filter_bbduk:
    input:
        fastq = _filter_get_contaminants_clean,
        ref = 'data/ext/rrna/ribokmers.fa.gz'
    output:
        fastq = 'data/tmp/GCF-2018-547-tmp/smallrna/filtered/{sample}/rrna.bbmap.clean.fastq',
        counts = 'data/processed/smallrna/filtered/{sample}/rrna.bbmap.counts'
    conda:
        'envs/filter.yaml'
    log:
        'logs/{sample}/filter.rrna.bbduk.log'
    shell:
        'bbduk.sh in={input.fastq} k=29 rcomp=f outm={output.fastq} stats={output.counts} ref={input.ref} 2> {log}'

    
def _filter_clean_fastq(wildcards):
    rib = config.get('filter_ribosomal', True)
    if rib:
        return 'data/tmp/GCF-2018-547-tmp/smallrna/filtered/{}/rrna.bbmap.clean.fastq'.format(wildcards.sample)
    else:
        return _filter_get_contaminants_clean(wildcards)
