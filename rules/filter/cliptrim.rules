#-*- mode:snakemake -*-

ADAPTER = config.get('adapter', 'TGGAATTCTCGG')

rule filter_adapter_atropos:
    input:
        fastq = _filter_get_raw
    output:
        trimmed = temp('data/tmp/GCF-2018-547-tmp/smallrna/filtered/atropos/{sample}/trimmed.fastq'),
        untrimmed = temp('data/tmp/GCF-2018-547-tmp/smallrna/filtered/atropos/{sample}/untrimmed.fastq')
    params:
        args = '--mirna'
    conda:
        'envs/filter.yaml'
    threads:
        4
    log:
        'logs/{sample}/atropos.log'
    shell:
        'atropos trim '
        '-se {input.fastq} '
        '--untrimmed-output {output.untrimmed} '
        '-o {output.trimmed} '
        '-T {threads} '
        '{params.args} '
        ' > {log}'

rule filter_bioscientific_trimmed:
    input:
        fastq = rules.filter_adapter_atropos.output.trimmed
    output:
        fastq = temp('data/tmp/GCF-2018-547-tmp/smallrna/filtered/bioscientific/{sample}.1.fastq')
    params:
        '-f 4 -t 4 -A -G --low_complexity_filter'
    threads:
        4
    conda:
        'envs/filter.yaml'
    log:
        html = 'logs/{sample}/fastp.trimmed.html',
        json = 'logs/{sample}/fastp.trimmed.json'
    shell:
        'fastp '
        '-i {input.fastq} '
        '-o {output.fastq} '
        '{params} ' 
        '--json {log.json} '
        '--html {log.html} '

rule filter_bioscientific_untrimmed:
    input:
        fastq = rules.filter_adapter_atropos.output.untrimmed
    output:
        fastq = temp('data/tmp/GCF-2018-547-tmp/smallrna/filtered/bioscientific/{sample}.2.fastq')
    params:
        '-f 4 -A -G --low_complexity_filter'
    threads:
        4
    conda:
        'envs/filter.yaml'
    log:
        html = 'logs/{sample}/fastp.trimmed.html',
        json = 'logs/{sample}/fastp.trimmed.json'
    shell:
        'fastp '
        '-i {input.fastq} '
        '-o {output.fastq} '
        '{params} ' 
        '--json {log.json} '
        '--html {log.html} '

rule filter_bioscientific:
    input:
        rules.filter_bioscientific_trimmed.output.fastq,
        rules.filter_bioscientific_untrimmed.output.fastq
    output:
        'data/tmp/GCF-2018-547-tmp/smallrna/filtered/bioscientific/{sample}.fastq.gz'
    shell:
        'cat {input} | gzip > {output}'

rule filter_trueseq:
    input:
        rules.filter_adapter_atropos.output
    output:
        'data/tmp/GCF-2018-547-tmp/smallrna/filtered/trueseq/{sample}.fastq.gz'
    params:
        '-A -G --low_complexity_filter'
    threads:
        4
    conda:
        'envs/filter.yaml'
    log:
        html = 'logs/{sample}/fastp.html',
        json = 'logs/{sample}/fastp.json'
    shell:
        'cat {input} | fastp --stdin '
        '-o {output} '
        '{params} ' 
        '--json {log.json} '
        '--html {log.html} '

def _filter_get_trimmed(wildcards):
    kit = config.get('kit', 'bioscientific')
    if kit == 'trueseq':
        return 'data/tmp/GCF-2018-547-tmp/smallrna/filtered/trueseq/{}.fastq.gz'.format(wildcards.sample)
    elif kit == 'bioscientific':
        return 'data/tmp/GCF-2018-547-tmp/smallrna/filtered/bioscientific/{}.fastq.gz'.format(wildcards.sample)
    else:
        raise ValueError('Kit argument: {} not supprted'.format(kit))
