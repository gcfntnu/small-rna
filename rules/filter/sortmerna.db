#-*-mode:snakemake-*-
from os import environ
from os.path import join

_SORTMERNA_TMP = os.path.join(environ.get('TMPDIR', '/tmp'), 'sortmerna')

rule sortmerna_db:
    params:
        out = join(EXT_DIR, 'sortmerna'),
        github = config['filter']['sortmerna']['rrna_db']
    output:
        join(EXT_DIR, 'sortmerna', 'silva-arc-16s-id95.fasta'),
        join(EXT_DIR, 'sortmerna', 'silva-arc-23s-id98.fasta'),
        join(EXT_DIR, 'sortmerna', 'silva-bac-16s-id90.fasta'),
        join(EXT_DIR, 'sortmerna', 'silva-bac-23s-id98.fasta'),
        join(EXT_DIR, 'sortmerna', 'silva-euk-18s-id95.fasta'),
        join(EXT_DIR, 'sortmerna', 'silva-euk-28s-id98.fasta'),
        join(EXT_DIR, 'sortmerna', 'rfam-5.8s-database-id98.fasta'),
        join(EXT_DIR, 'sortmerna', 'rfam-5s-database-id98.fasta')
    conda:
        'envs/sortmerna.yaml'
    singularity:
        'docker://flatberg/filter:0.1'
    shell:
        'svn co {params.github} {SORTMERNA_TMP} '
        '&& '
        'mkdir -p {params.out} '
        '&& '
        'mv {SORTMERNA_TMP}/*.fasta {params.out}/ '

rule sortmerna_index_one:
    input:
        fasta = join(EXT_DIR, 'sortmerna', '{db}.fasta')
    params:
        index = join(EXT_DIR, 'sortmerna', '{db}.idx')
    output:
        join(EXT_DIR, 'sortmerna', '{db}.idx.stats')
    conda:
        'envs/sortmerna.yaml'
    shell:
        'indexdb_rna --ref {input.fasta},{params.index}'

DB = 'silva-arc-16s-id95 silva-arc-23s-id98 silva-bac-16s-id90 silva-bac-23s-id98 silva-euk-18s-id95 silva-euk-28s-id98 rfam-5.8s-database-id98 rfam-5s-database-id98'.split()

rule sortmerna_all:
    input:
        expand(join(EXT_DIR, 'sortmerna', '{db}.idx.stats'), db=DB)
