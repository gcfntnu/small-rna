#-*- mode:snakemake -*-

MIRBASE_RELEASE = config.get('mirbase_release', '22')
MIR_ORG = {'homo_sapiens': 'hsa',
           'human': 'hsa',
           'hsa': 'hsa',
           'mus_musculus': 'mmu',
           'mouse': 'mmu',
           'mmu': 'mmu',
           'rattus_norvegicus': 'rno',
           'rat': 'rno',
           'rno': 'rno'}

rule mirbase_hairpin_fasta:
    params:
        url = 'ftp://mirbase.org/pub/mirbase/{}/hairpin.fa.gz'.format(MIRBASE_RELEASE),
        mirbase_org = lambda wildcards: MIR_ORG[wildcards.org]
    output:
        'data/ext/mirbase/{org}/hairpin.fa'
    shell:
        """
        wget {params.url}
	zcat  hairpin.fa.gz | grep -A 1 "^>{params.mirbase_org}" | grep -v "^-" | sed 's/U/T/g' > {output}
        rm hairpin.fa.gz
        """
        
rule mirbase_mature_fasta:
    params:
        url = 'ftp://mirbase.org/pub/mirbase/{}/mature.fa.gz'.format(MIRBASE_RELEASE),
        mirbase_org = lambda wildcards: MIR_ORG[wildcards.org]
    output:
        'data/ext/mirbase/{org}/mature.fa'
    shell:
        """
        wget {params.url}
	zcat  mature.fa.gz | grep -A 1 "^>{params.mirbase_org}" | grep -v "^-" | sed 's/U/T/g' > {output}
        rm mature.fa.gz
        """

rule mirbase_gff:        
    params:
        url = 'ftp://mirbase.org/pub/mirbase/{}/genomes'.format(MIRBASE_RELEASE),
        mirbase_org = lambda wildcards: MIR_ORG[wildcards.org]
    output:
        'data/ext/mirbase/{org}/{org}.gff3'
    shell:
        'wget -O - {params.url}/{params.mirbase_org}.gff3 > {output}'
